<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Custom Elements v1 - EagleLand</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel="shortcut icon" href=/favicon.png><link rel="shortcut icon" href=/favicon.svg type=image/svg+xml sizes=any><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://unpkg.com/@highlightjs/cdn-assets@11.11.1/styles/a11y-dark.min.css><link rel=stylesheet href=/css/settings.css><link rel=stylesheet href=/css/base.css><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/components.css><link rel=stylesheet href=/css/experimental.css><link rel=alternate href=/rss.xml title=1000ch.net type=application/rss+xml><meta name=author content="Shogo Sensui"><meta name=copyright content="Copyright (c) Shogo Sensui; Licensed under Creative Commons Attribution-Noncommercial-Share Japan"><meta property="og:description" content="Custom Elements v1 が Chrome の 54 からサポートされた。
これまでの document.registerElement('custom-element') によるカスタム要素の定義は v0 にあたり、 v1 は様々な見直しがなされた Custom Elements の新しいバージョンである。
定義方法の変更 v0 document にぶら下がる registerElement() で要素を定義してきた。 registerElement() は定義されたカスタム要素のコンストラクタを返す。
// カスタム要素の定義 const FooElement = document.registerElement('foo-element', { prototype: FooElementPrototype }); // <button is=&#34;bar-button&#34;></button> const BarButton = document.registerElement('bar-button', { prototype: FooElementPrototype, extends: 'button' }); v1 window に customElements というオブジェクトが追加される。 customElements は CustomElementRegistory という IDL である。
カスタム要素に関する操作はこの customElements を通して行われ、customElements.define('element-name') でカスタム要素を定義し、 customElements.get('element-name') でカスタム要素を参照し、 customElements.whenDefined('element-name') でカスタム要素が定義されるタイミングを取得する。 whenDefined() の返り値は Promise である。"><meta property="og:image" content="https://1000ch.net//img/apple-touch-icon.png"><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta property="og:url" content="https://1000ch.net/posts/2016/custom-elements-v1/"><meta property="og:site_name" content="EagleLand"><meta property="og:title" content="Custom Elements v1"><meta name=twitter:site content="@1000ch"><meta name=twitter:url content="https://1000ch.net/posts/2016/custom-elements-v1/"><meta name=twitter:title content="Custom Elements v1"><meta name=google-site-verification content="BWewniqiBzRmrhpj51eLwug-F4hamFfyznl-ARb-Y4Y"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-49530352-1","1000ch.net"),ga("send","pageview")</script></head><body><div class=container><header class=header><h1 class=header-title><a href=/><img src=/img/icon.svg>
<span>EagleLand</span></a></h1><nav><a href=/rss.xml>📻 RSS</a>
<a href="https://www.google.co.jp/search?q=site%3A1000ch.net">🔍 検索</a>
<a href=https://shogosensui.com>🌎 Author</a></nav></header><main class=main><h1>Custom Elements v1</h1><p style=margin:0;text-align:right>Published at 2016-09-16</p><p>Custom Elements v1 が <a href=https://www.chromestatus.com/features/4696261944934400>Chrome の 54 からサポートされた</a>。</p><p>これまでの <code>document.registerElement('custom-element')</code> によるカスタム要素の定義は v0 にあたり、 v1 は様々な見直しがなされた Custom Elements の新しいバージョンである。</p><h2 id=定義方法の変更>定義方法の変更</h2><h3 id=v0>v0</h3><p><code>document</code> にぶら下がる <code>registerElement()</code> で要素を定義してきた。 <code>registerElement()</code> は定義されたカスタム要素のコンストラクタを返す。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// カスタム要素の定義
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FooElement</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>registerElement</span>(<span style=color:#e6db74>&#39;foo-element&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>prototype</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>FooElementPrototype</span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// &lt;button is=&#34;bar-button&#34;&gt;&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>BarButton</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>registerElement</span>(<span style=color:#e6db74>&#39;bar-button&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>prototype</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>FooElementPrototype</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extends</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;button&#39;</span>
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=v1>v1</h3><p><code>window</code> に <code>customElements</code> というオブジェクトが追加される。 <code>customElements</code> は <a href=https://www.w3.org/TR/custom-elements/#dom-customelementregistry><code>CustomElementRegistory</code></a> という IDL である。</p><p>カスタム要素に関する操作はこの <code>customElements</code> を通して行われ、<code>customElements.define('element-name')</code> でカスタム要素を定義し、 <code>customElements.get('element-name')</code> でカスタム要素を参照し、 <code>customElements.whenDefined('element-name')</code> でカスタム要素が定義されるタイミングを取得する。 <code>whenDefined()</code> の返り値は <code>Promise</code> である。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// カスタム要素の定義
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;foo-element&#39;</span>, <span style=color:#a6e22e>FooElement</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// &lt;button is=&#34;bar-button&#34;&gt;&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;bar-button&#39;</span>, <span style=color:#a6e22e>BarButton</span>, {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extends</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;button&#39;</span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// コンストラクタの参照
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FooElement</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;foo-element&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 要素が定義されたタイミングの取得
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>whenDefined</span>(<span style=color:#e6db74>&#39;baz-element&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;baz-element is defined&#39;</span>));
</span></span></code></pre></div><p><code>&lt;button is="app-button">&lt;/button></code> のように、ネイティブのHTML要素の拡張として機能させることも、従来のように可能。 <code>customElements.define()</code> の第三引数に <code>{ extends: 'button' }</code> のようなオプションを渡す。</p><p>カスタム要素の名前にはハイフンを含む必要があるとか、同じ名前のカスタム要素を再定義はできないといった基本的なルールは v0 から変化なし。</p><h2 id=ライフサイクルの変更>ライフサイクルの変更</h2><h3 id=v0-1>v0</h3><ol><li><code>createdCallback()</code>: 要素が生成された時</li><li><code>attachedCallback()</code>: 要素がHTMLに追加された時</li><li><code>detachedCallback()</code>: HTMLから要素が除かれた時</li><li><code>attributeChangedCallback()</code>: 要素の属性が変更された時</li></ol><h3 id=v1-1>v1</h3><ol><li><code>constructor()</code>: 要素が生成または更新された時</li><li><code>connectedCallback()</code>: 要素がHTMLに追加された時</li><li><code>disconnectedCallback()</code>: HTMLから要素が除かれた時</li><li><code>attributeChangedCallback()</code>: 要素の属性が変更された時</li><li><code>adoptedCallback()</code>: 要素が新たなドキュメントに移動した時</li></ol><p><code>adoptedCallback()</code> は <strong>要素が新たなドキュメントに移動した時</strong> とあるが、 <code>document.adoptNode()</code> などを通して元のツリーから削除し、実行者の <code>document</code> に追加されたタイミングで、つまり <code>ownerDocument</code> が変更されたタイミングと言い換えられる。</p><h2 id=class-ベースの要素定義>class ベースの要素定義</h2><p>v0 から <a href=/posts/2016/web-components-es2015-class/>ES2015 の <code>class</code> で定義可能だった</a>が、 先のように <code>constructor</code> がライフサイクルに含むこともあり、改めて次のようになる。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;header-tab&#39;</span>, <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HeaderTab</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>HTMLElement</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>observedAttributes</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#e6db74>&#39;selected&#39;</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>selected</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hasAttribute</span>(<span style=color:#e6db74>&#39;selected&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set</span> <span style=color:#a6e22e>selected</span>(<span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setAttribute</span>(<span style=color:#e6db74>&#39;selected&#39;</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>removeAttribute</span>(<span style=color:#e6db74>&#39;selected&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// HTMLElement の constructor を呼び出す
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectedCallback</span>() { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>disconnectedCallback</span>() { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attributeChangedCallback</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>oldValue</span>, <span style=color:#a6e22e>newValue</span>) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>adoptedCallback</span>() { ... }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ライフサイクルの他に追加されているのがクラスプロパティとして定義している <code>observedAttributes</code> だが、ここで指定された属性のみが値変更の監視対象となる。そのため、ここで指定していない属性が変更されても <code>attributeChangedCallback()</code> には通知されない。</p><h2 id=lazyload-image-に見るワークアラウンド>lazyload-image に見るワークアラウンド</h2><p>画像をスクロール同期でロードさせる <a href=https://github.com/1000ch/lazyload-image>1000ch/lazyload-image</a> を Custom Elements v1 で再実装したのが <a href="https://github.com/1000ch/lazyload-image/pull/9/files?diff=split">efine with customElements.define() #9</a> だが、想定通り動かない（ <code>HTMLImageElement</code> を <code>Image</code> に変えてもダメだった）。</p><h2 id=参考>参考</h2><ul><li><a href=https://html.spec.whatwg.org/multipage/scripting.html#custom-elements>4.13 Custom elements - HTML Standard</a></li><li><a href=https://developers.google.com/web/fundamentals/primers/customelements/>Custom elements v1: reusable web components | Web Fundamentals - Google Developers</a></li></ul><aside class=nav><button type=button class=link id=share-button>🔗 この記事をシェアする</button>
<a href=https://github.com/1000ch/1000ch.net/edit/main/content/posts/2016/custom-elements-v1.md>🔗 この記事を GitHub で編集する</a><div><a href=/posts/2016/soft-skills/>👈 SOFT SKILLS　ソフトウェア開発者の人生マニュアル</a></div><div><a href=/posts/2016/github-japan/>👉 GitHub Japanを訪問してきた</a></div></aside><div popover=auto id=popover>タイトルと URL をコピーしました</div></main><aside class=aside></aside><footer class=footer><h2>Preference</h2><div class=preference><label><input type=checkbox switch id=auto-phrase> 日本語のフレーズ改行
</label><label><input type=checkbox switch id=dark-mode> ダークモード
</label><label><input type=checkbox switch id=rainbow-link> 虹色リンク</label></div><h2>Notice</h2><ul class=notice><li>コンテンツの正確性や信頼性には配慮していますが、必ずしもそれらを保証はしません。意見や見解は、個人の立場において述べたものであり、所属組織等を代表するものではありません。コンテンツの利用およびその結果に対し、一切の責任を負いかねます</li><li>当サイトは amazon.co.jp を宣伝しリンクすることによって、サイトが紹介料を獲得できる手段を提供することを目的に設定されたアフィリエイト宣伝プログラムである、Amazon アソシエイト・プログラムの参加者です</li></ul></footer></div><script defer src=https://platform.twitter.com/widgets.js></script><script defer src=https://platform.instagram.com/en_US/embeds.js></script><script defer src=https://strava-embeds.com/embed.js></script><script defer src=https://embed.bsky.app/static/embed.js></script><script type=module src=https://unpkg.com/baseline-status@1.0.11/baseline-status.min.js></script><script type=module>
import hljs from 'https://unpkg.com/@highlightjs/cdn-assets@11.11.1/es/highlight.min.js';

document.querySelectorAll('pre code').forEach(element => {
  hljs.highlightElement(element);
});
</script><script type=module>
import AffiliateLink from '/js/affiliate-link.js';

customElements.define('affiliate-link', AffiliateLink);

const autoPhrase = document.querySelector('#auto-phrase');
const darkMode =  document.querySelector('#dark-mode');
const rainbowLink =  document.querySelector('#rainbow-link');

autoPhrase.checked = localStorage.getItem('auto-phrase');
darkMode.checked = localStorage.getItem('dark-mode');
rainbowLink.checked = localStorage.getItem('rainbow-link');

autoPhrase?.addEventListener('change', event => {
  if (event.target.checked) {
    localStorage.setItem('auto-phrase', true);
  } else {
    localStorage.removeItem('auto-phrase');
  }
});

darkMode?.addEventListener('change', event => {
  if (event.target.checked) {
    localStorage.setItem('dark-mode', true);
  } else {
    localStorage.removeItem('dark-mode');
  }
});

rainbowLink.addEventListener('change', event => {
  if (event.target.checked) {
    localStorage.setItem('rainbow-link', true);
  } else {
    localStorage.removeItem('rainbow-link');
  }
});

const shareButton = document.querySelector('#share-button');
shareButton?.addEventListener('click', async event => {
  event.preventDefault();

  const data = {
    title: document.title,
    text: document.title,
    url: location.href
  };

  if (navigator.canShare?.(data)) {
    await navigator.share(data);
  } else {
    await navigator.clipboard?.writeText(`${data.title} ${data.url}`);
    const popover = document.querySelector('#Popover');
    popover.showPopover();

    setTimeout(() => {
      popover.hidePopover();
    }, 2000);
  }
});
</script></body></html>