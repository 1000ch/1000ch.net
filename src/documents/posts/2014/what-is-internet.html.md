---
layout: post
title: Webにおけるネットワーク通信
date: 2014-12-03
description: この記事はFrontrend Advent Calendar 2014 3日目の記事です。
---

# Webにおけるネットワーク通信

「ネットワークってなんだろう？」と考えたことはあるだろうか。前職でもプログラマとして働いていたものの、（恥ずかしながら）知識は皆無に近かったし、Webのフロントエンジニアとして舵を切った2年と5ヶ月前は、この手の話がフロントエンドに関わるとは思ってもいなかった。

でも、複雑なWebアプリの開発現場や進化するWeb技術、パフォーマンスに取り組む中で、Webがどのような仕組みで動いているかは間違いなく必要な知識であり、Webに従事していれば職域に関わらないものだと思う。

HTTPだの、WebSocketだの、言葉は耳にするけど実態はよくわからない
…という人も多いと思う。私自身も深く密着しているわけではないし、語るほど詳しいかと言われれば疑問符が残る。それでも、今までモヤモヤしていたところを少しでも晴らす手助けが出来ればと思い、今日はインターネットの世界で何が起こっているかについての記事を書きたい。

## そもそもサーバーとは？

サーバーって一体何だろうと思っている人も多いのではないだろうか？手元のパソコン、iPhone、Androidといった **クライアントからの要求を待ち、応答する役割を担っているのがサーバー** である。応答するプログラムであれば端末の種別は問わないが、起動しっぱなしのパソコンと思ってもらえばわかりやすいかもしれない。

### 電話におけるサーバー

クライアントからの応答を待つ役割をするサーバーは、インターネットに限った話ではない。例えば電話でのやりとりに於いても、サーバーは存在する。

1. 電話のかけ手が、番号を入力し発信する
2. サーバーが入力された番号を探す
3. 電話の受け手が受信する
4. サーバーを介して通話を開始する

![](/img/posts/what-is-internet/network1.gif)

このように、家の置き電話や携帯電話があるだけでは通話は成立せず、通話が確立するまでや、その後の通話（音声データのやりとり）もサーバーを介して行われている。

### Webにおけるサーバー

ブラウザにURLを入力し、表示されたWebページを閲覧するということは誰しもが当たり前のようにやっていることだが、実はここでもサーバーが一役買っている。

1. 入力されたURLのサーバーに対し、ブラウザが接続要求をする
2. サーバーが接続要求に対し、応答する（接続開始）
3. ブラウザがURLに関するリソースの要求をする
4. サーバーがリソース（HTML）を送信する

![](/img/posts/what-is-internet/network2.gif)

厳密に言えば、URLに対してブラウザが接続要求を実行するタイミングでDNS解決というURL（ホスト名）からIPアドレスへの変換が行われる。インターネットにおける端末間の通信には、お互いを一意に認識するデータとしてIPアドレスを知っている必要があるためだ。先程の電話の場合は、電話番号がその役割を果たしている。

このクライアントの要求を **リクエスト** 、サーバーからの応答を **レスポンス** という。そして、1つのリクエストにつき、この1~3のステップが行われることを **3ウェイ・ハンドシェイク** という。

## サーバーとクライアントのやりとり

Webページの表示するために、クライアントとサーバーがやりとりを行っていることがわかった。次にどのようなやりとりを行っているかを見てみよう。

やりとりの中にはルールが存在している。普段の生活で言えば、 **日本語のような決まった言語でやりとりをする** であったり、 **面と向かって、または何かしらのツール上でメッセージの交換をする** といったように、何かしら縛りがあるはずだ。

クライアントがサーバーとやりとりを行う際も、ある一定のルールの中でやりとりが行われる。このコンピュータが行うやりとりにおけるルールをプロトコルと言う。以下、[Wikipediaより引用](http://ja.wikipedia.org/wiki/%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB)。

>プロトコルまたはプロトコール（英語 protocol 英語発音: [ˈproutəˌkɔːl] プロウタコール、[ˈproutəˌkɔl] プロウタコル、フランス語 protocole フランス語発音: [prɔtɔkɔl] プロトコル）とは、複数の者が対象となる事項を確実に実行するための手順等について定めたもの。日本語では「規定」「議定書」「儀典」などと意訳される。もともとは人間同士のやりとりに関する用語としてのみ用いられていたが、近年では派生的に、情報工学分野でマシンやソフトウェア同士のやりとりに関する概念を指すためにも用いられるようになった。

### インターネットにおけるプロトコル

プロトコルの中でも、特に通信に関するプロトコルは通信プロトコルと言う。そして昨今のインターネットにおいては、HTTP（Hypertext Transfer Protocol）が最も多くの割合を占めている。以下、[Wikipediaより引用](http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol)。

>Hypertext Transfer Protocol（ハイパーテキスト・トランスファー・プロトコル、略称 HTTP）とは、WebブラウザとWebサーバの間でHTMLなどのコンテンツの送受信に用いられる通信プロトコルである。ハイパーテキスト転送プロトコルとも呼ばれる。

静的なWebサイト・動的なWebアプリケーションを問わず、この一定のルールの元でやりとりが行われ、ブラウザにデータが返却される。つまり、 **サーバーとクライアントがHTTPというルール（プロトコル）のもとで、データのやりとりを行う** ということになる。

HTTPはその名の通り、ハイパーテキスト（HTML）の転送を主な目的としているが、それ以外にも画像や音声等のバイナリを含めて、様々なデータを扱うことが出来る。

### Webページで発生しているHTTPリクエスト

ブラウザにURLを入力してWebページを表示するために、クライアント（ブラウザ）がリクエストし、サーバーがレスポンスする。ブラウザにおけるURL入力やリンクの押下が、ページ表示における最初のリクエストにあたり、殆どのWebサーバーはHTMLを返却する。

```html
<html>
  <head>
    <title>ページタイトル</title>
    <link rel='stylesheet' href='style.css'>
  </head>
  <body>
    <div class='container'>
      <img src='image.png'>
      <img src='image.jpg'>
      <img src='image.gif'>
    </div>
    <script src='jquery.min.js'></script>
    <script src='app.min.js'></script>
  </body>
</html>
```

サーバーからHTMLが返却され、ブラウザがそれを受け取って、やりとりが終わるわけではない。まず、ブラウザは返却されたHTMLを解析する。上記の例は何の変哲もないHTMLだが、幾つか外部リソースを必要とする指定が存在する。

- `<link rel='stylesheet' href='style.css'>`
- `<img src='image.png'>`
- `<img src='image.jpg'>`
- `<img src='image.gif'>`
- `<script src='jquery.min.js'></script>`
- `<script src='app.min.js'></script>`

これらの要素の`href`属性、及び`src`属性には外部リソースの要求を指定する（外部リソースを指定する要素は他にも、`<audio>`や`<video>`、CSSファイル内のパス指定等、色々ある）。よって、ここから更に、HTTPリクエストが断続的に発生する。

![](/img/posts/what-is-internet/network3.gif)

光回線のようなブロードバンド、モバイル端末向けでは4G回線も普及し、私達を取り巻くネットワーク環境は以前よりも良くなったものの、ハードウェアの進化に比べれば遅く、そして不安定である。Webページの最適化の為にHTTPリクエストを減らすというアプローチは、かなり浸透してきたが、こうした環境も背景にあるだろう。